"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("react"),n=(e=t)&&"object"==typeof e&&"default"in e?e.default:e,r=require("planck-js");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function o(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t.indexOf(n=o[r])>=0||(i[n]=e[n]);return i}require("planck-js/lib");var a,u,c=t.createContext(null),s=function(){return t.useContext(c).world},f=function(){return t.useContext(c)},l=function(e){var n=t.useRef(0),r=t.useRef({}),i=t.useCallback((function(e){var t=n.current;return n.current+=1,r.current[t]=e,function(){delete r.current[t]}}),[r]);return t.useEffect((function(){if(e){var t=e.onmessage;e.onmessage=function(e){Object.values(r.current).forEach((function(t){t(e)})),t&&t(e)}}}),[e,r]),i};!function(e){e[e.INIT=0]="INIT",e[e.STEP=1]="STEP",e[e.LOGIC_FRAME=2]="LOGIC_FRAME",e[e.ADD_BODY=3]="ADD_BODY",e[e.REMOVE_BODY=4]="REMOVE_BODY",e[e.SET_BODY=5]="SET_BODY",e[e.UPDATE_BODY=6]="UPDATE_BODY",e[e.PHYSICS_STEP_PROCESSED=7]="PHYSICS_STEP_PROCESSED"}(a||(a={})),function(e){e[e.FRAME=0]="FRAME",e[e.PHYSICS_STEP=1]="PHYSICS_STEP",e[e.SYNC_BODIES=2]="SYNC_BODIES",e[e.BEGIN_COLLISION=3]="BEGIN_COLLISION",e[e.END_COLLISION=4]="END_COLLISION",e[e.MESSAGE=5]="MESSAGE",e[e.INITIATED=6]="INITIATED"}(u||(u={}));var d,v,g=function(e){return e.getUserData()||null},S=function(e){return e&&e.uuid?e.uuid:""},p=function(e){return e?e.fixtureIndex:-1};!function(e){e.static="static",e.kinematic="kinematic",e.dynamic="dynamic"}(d||(d={})),function(e){e.box="box",e.circle="circle"}(v||(v={}));var b=t.createContext(null),y=function(){return t.useContext(b)},E=function(e){var r=e.children,i=t.useState((function(){return new Map}))[0],o=t.useState((function(){return new Set}))[0],a=t.useState((function(){return new Set}))[0],u=t.useState(!1),c=u[0],s=u[1],f=t.useRef(!1),l=t.useRef(!1);return n.createElement(b.Provider,{value:{bodies:i,dynamicBodies:o,collisionListeners:a,bodiesNeedSync:c,setBodiesNeedSync:s,bodiesNeedSyncRef:f,logicBodiesNeedSyncRef:l}},r)},C=r.Vec2(0,0),I=function(){var e,n,u,c,l=y().bodies,g=t.useState((function(){return new Map}))[0],S=function(e,n){var a=y(),u=a.dynamicBodies,c=a.collisionListeners,f=a.bodiesNeedSyncRef,l=a.logicBodiesNeedSyncRef,g=t.useCallback((function(e){u.add(e),f.current=!0,l.current=!0}),[u,f,l]),S=t.useCallback((function(e){c.add(e)}),[c]),p=s(),b=t.useCallback((function(e){var t=n.get(e);if(t&&t.length>0){var r=t.pop();if(r)return r}return null}),[n]);return t.useCallback((function(t){var n=t.uuid,a=t.cacheKey,u=t.listenForCollisions,c=t.fixtures,s=void 0===c?[]:c,f=t.attachToRope,l=void 0!==f&&f,y=o(t,["uuid","cacheKey","listenForCollisions","fixtures","attachToRope"]),E=e.get(n);if(E)return E;u&&S(n);var C=i({type:d.static,fixedRotation:!0},y),I=C.type,x=null;if(a){var B=b(a);B&&(x=function(e,t){var n=t.uuid,r=t.fixtures,a=void 0===r?[]:r,u=o(t,["uuid","cacheKey","listenForCollisions","fixtures","attachToRope"]);if(a&&a.length>0){var c=e.getFixtureList();a.forEach((function(e,t){var r,o=e.fixtureOptions;o=i({userData:i({uuid:n,fixtureIndex:t},null==(r=o)?void 0:r.userData)},o),c&&(o&&c.setUserData(o.userData),c=c.getNext())}))}var s=u.position,f=u.angle;return s&&e.setPosition(s),f&&e.setAngle(f),e.setActive(!0),e}(B,t))}if(x||(x=p.createBody(C),s&&s.length>0&&s.forEach((function(e,t){var o,a,u,c=e.shape,s=null!=(o=e.fixtureOptions)?o:{};switch(s=i({},s,{userData:i({uuid:n,fixtureIndex:t},null==(a=s)?void 0:a.userData)}),c){case v.box:var f=e.center;u=r.Box(e.hx/2,e.hy/2,f?r.Vec2(f[0],f[1]):void 0);break;case v.circle:u=r.Circle(e.radius);break;default:throw new Error("Unhandled body shape "+c)}if(s?x&&x.createFixture(u,s):x&&x.createFixture(u),l){var g=y.position,S={maxLength:.5,localAnchorA:g,localAnchorB:g},b=p.createBody({type:d.static,fixedRotation:!0,position:g,angle:y.angle});if(x){var E=r.DistanceJoint({collideConnected:!1,frequencyHz:5,dampingRatio:.5,length:.15},b,x,null!=g?g:r.Vec2(0,0),null!=g?g:r.Vec2(0,0));p.createJoint(r.RopeJoint(S,b,x,null!=g?g:r.Vec2(0,0))),p.createJoint(E)}}}))),I!==d.static&&g(n),!x)throw new Error("No body");return e.set(n,x),x}),[p,e,b,g,S])}(l,g),p=function(e,n){var r=s(),i=y(),o=i.dynamicBodies,a=i.collisionListeners,u=i.bodiesNeedSyncRef,c=i.logicBodiesNeedSyncRef;return t.useCallback((function(t){var i=t.uuid,s=t.cacheKey;o.has(i)&&(o.delete(i),u.current=!0,c.current=!0),a.delete(i);var f=e.get(i);if(f)if(e.delete(i),s){C.set(-1e3,-1e3),f.setPosition(C),C.set(0,0),f.setLinearVelocity(C),f.setActive(!1);var l=n.get(s);l?l.push(f):n.set(s,[f])}else r.destroyBody(f);else console.warn("Body not found for "+i)}),[r,e,o,a,u,c,n])}(l,g),b=function(e){return t.useCallback((function(t){var n=t.uuid,r=t.method,i=t.methodParams,o=e.get(n);o?o[r].apply(o,i):console.warn("Body not found for "+n,e)}),[e])}(l),E=function(e){return t.useCallback((function(t){var n=t.uuid,r=t.data,i=e.get(n);if(i){var o=r.fixtureUpdate;if(o){var a=i.getFixtureList();if(a){var u=o.groupIndex,c=o.categoryBits,s=o.maskBits;if(void 0!==u||void 0!==c||void 0!==s){var f=a.getFilterGroupIndex(),l=a.getFilterCategoryBits(),d=a.getFilterMaskBits();a.setFilterData({groupIndex:void 0!==u?u:f,categoryBits:void 0!==c?c:l,maskBits:void 0!==s?s:d})}}}}else console.warn("Body not found for "+n)}),[e])}(l),I=t.useCallback((function(e){var t=e.data,n=t.props,r=void 0===n?{}:n;switch(t.type){case a.ADD_BODY:S(r);break;case a.REMOVE_BODY:p(r);break;case a.SET_BODY:b(r);break;case a.UPDATE_BODY:E(r)}}),[S,p,b,E]);return e=I,n=f(),t.useEffect((function(){var t=u(e),n=c(e);return function(){t(),n()}}),[u=n.subscribe,c=n.logicSubscribe,e]),null},x=function(e){var n=y(),r=n.bodiesNeedSyncRef,o=n.logicBodiesNeedSyncRef,a=n.dynamicBodies,c=function(){var e=y(),n=e.dynamicBodies,r=e.bodies;return t.useCallback((function(e,t){Array.from(n).forEach((function(n,i){var o=r.get(n);if(o){var a=o.getPosition(),u=o.getAngle();e[2*i+0]=a.x,e[2*i+1]=a.y,t[i]=u}}))}),[])}();return t.useCallback((function(t,n,s){var f=n.positions,l=n.angles;if(0!==f.byteLength&&0!==l.byteLength){c(f,l);var d={type:u.PHYSICS_STEP,physicsTick:e.current};s?(d.bodies=Array.from(a),r.current=!1):(d.bodies=Array.from(a),o.current=!1);var v=i({},d,{positions:f,angles:l});t.postMessage(v,[f.buffer,l.buffer])}}),[r,o,e,c])},B=function(){return function(){var e=s(),n=f(),r=n.updateRate,i=n.subscribe,o=n.logicSubscribe,u=t.useRef(0),c=function(e){var n=f(),r=n.buffers,i=n.logicBuffers,o=n.worker,a=n.logicWorker,u=x(e),c=t.useCallback((function(){u(o,r,!0),a&&u(a,i,!1)}),[o,a,u,r,i]),s=t.useRef(c);return t.useEffect((function(){s.current=c}),[c,s]),t.useCallback((function(){s.current()}),[s])}(u);t.useEffect((function(){var t=setInterval((function(){u.current+=1,e.step(r),c()}),r);return function(){clearInterval(t)}}),[]);var l=function(e){var n=f(),r=n.buffers,i=n.logicBuffers,o=n.worker,a=n.logicWorker,u=x(e);return t.useCallback((function(t,n,c,s){var f=t?r:i;f.positions=c,f.angles=s,n<e.current&&(t?u(o,f,!0):a&&u(a,f,!1))}),[r,i,e,o,a,u])}(u);t.useEffect((function(){var e=function(e,t){void 0===t&&(t=!0),e.data.type===a.PHYSICS_STEP_PROCESSED&&l(t,e.data.physicsTick,e.data.positions,e.data.angles)},t=i(e),n=o((function(t){return e(t,!1)}));return function(){t(),n()}}),[i,o,l])}(),null},O=function(){var e,n,r,i,o,a=s(),c=(e=f(),n=e.worker,r=e.logicWorker,i=y().collisionListeners,o=t.useCallback((function(e,t,i,o){var a={type:u.BEGIN_COLLISION,props:{uuid:e,data:t,fixtureIndex:i,isSensor:o}};n.postMessage(a),r&&r.postMessage(a)}),[n,r]),t.useCallback((function(e,t){var n=g(e),r=g(t),a=S(n),u=S(r);a&&i.has(a)&&o(a,r,p(n),t.isSensor()),u&&i.has(u)&&o(u,n,p(r),e.isSensor())}),[i,o])),l=function(){var e=f(),n=e.worker,r=e.logicWorker,i=y().collisionListeners,o=t.useCallback((function(e,t,i,o){var a={type:u.END_COLLISION,props:{uuid:e,data:t,fixtureIndex:i,isSensor:o}};n.postMessage(a),r&&r.postMessage(a)}),[n,r]);return t.useCallback((function(e,t){var n=g(e),r=g(t),a=S(n),u=S(r);a&&i.has(a)&&o(a,r,p(n),t.isSensor()),u&&i.has(u)&&o(u,n,p(r),e.isSensor())}),[i,o])}();return t.useEffect((function(){a.on("begin-contact",(function(e){var t=e.getFixtureA(),n=e.getFixtureB();c(t,n)})),a.on("end-contact",(function(e){var t=e.getFixtureA(),n=e.getFixtureB();l(t,n)}))}),[a]),null},h=function(e){var n=t.useState((function(){return{positions:new Float32Array(2*e),angles:new Float32Array(e)}}))[0];return t.useEffect((function(){n.positions=new Float32Array(2*e),n.angles=new Float32Array(e)}),[e]),n};exports.App=function(e){var o=e.worldParams,a=e.worker,s=e.config,f=s.updateRate,d=s.maxNumberOfDynamicObjects,v=i({allowSleep:!0,gravity:r.Vec2(0,0)},o),g=t.useState((function(){return r.World(v)}))[0],S=l(a),p=function(e,n){var r=t.useState(),i=r[0],o=r[1];return t.useEffect((function(){var e,t=n((function(t){t.data.command&&function(t){"connect"!==t.data.command?"forward"!==t.data.command||e.postMessage(t.data.message):o(e=t.ports[0])}(t)}));return function(){t()}}),[e,n,o]),i}(a,S),b=function(e){return l(e)}(p),y=h(d),C=h(p?0:d);return t.useEffect((function(){a.postMessage({type:u.INITIATED})}),[a]),n.createElement(c.Provider,{value:{world:g,updateRate:f,worker:a,logicWorker:p,subscribe:S,logicSubscribe:b,buffers:y,logicBuffers:C}},n.createElement(E,null,n.createElement(B,null),n.createElement(I,null),n.createElement(O,null)))};
//# sourceMappingURL=physicsapp.cjs.production.min.js.map
